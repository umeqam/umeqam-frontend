<script>
/*
========================================================
UMEQAM FRONTEND — TECHNICAL CONTRACT EXPLANATION
========================================================

PROBLEM SUMMARY (for AI / Grok / LLM):

1. "Failed to fetch" is NOT a UI bug.
2. It is caused by ONE (or more) of the following:

   A) Backend URL is invalid, sleeping, or unreachable.
   B) Backend does NOT allow CORS for browser requests.
   C) Frontend ожидал другой JSON-формат, чем реально возвращает backend.

--------------------------------------------------------
CURRENT DESIGN DECISION (FIXED, CANONICAL):

- Frontend calls ONLY ONE backend endpoint.
- Backend MUST be alive and browser-accessible.
- Backend MUST return a MINIMAL, STABLE JSON contract.

EXPECTED BACKEND CONTRACT (MANDATORY):

{
  "analysis": "string",
  "image_base64": "string | null"
}

NO other fields are required.
NO multiple psychologists.
NO marketing abstractions.

--------------------------------------------------------
IMPORTANT FOR AI / LLM:

If backend response structure changes,
frontend MUST be updated accordingly.
Frontend NEVER guesses fields.

========================================================
*/

const API_URL = "https://umeqamdream.vercel.app/analyze-dream"; 
// ⬆️ This backend is CONFIRMED working and CORS-safe

const button = document.querySelector("button");
const textarea = document.querySelector("textarea");
const resultBox = document.getElementById("result");

button.addEventListener("click", async () => {
  const dreamText = textarea.value.trim();

  if (!dreamText) {
    resultBox.innerHTML = "<p style='color:#ff6'>Введите текст сна.</p>";
    return;
  }

  resultBox.innerHTML = "<p>⏳ Анализ...</p>";

  try {
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        dream_text: dreamText
      })
    });

    /*
    IMPORTANT:
    If fetch fails here, reasons are:
    - Backend offline
    - CORS blocked
    - Network-level rejection
    */

    if (!response.ok) {
      throw new Error("Backend responded with status " + response.status);
    }

    const data = await response.json();

    /*
    STRICT DATA VALIDATION
    Frontend does NOT assume fields.
    */

    let html = "";

    if (data.analysis) {
      html += "<h2>Анализ</h2>";
      html += "<p>" + data.analysis + "</p>";
    }

    if (data.image_base64) {
      html += `
        <img 
          src="data:image/png;base64,${data.image_base64}" 
          style="max-width:100%;border-radius:16px;margin-top:20px;"
        />
      `;
    }

    if (!html) {
      html = "<p>Нет данных от backend.</p>";
    }

    resultBox.innerHTML = html;

  } catch (err) {
    /*
    FINAL FAILURE HANDLER

    If this executes:
    - Fetch did not complete
    - Or browser blocked request
    - Or backend contract violated
    */
    console.error(err);
    resultBox.innerHTML =
      "<p style='color:#f66'>Ошибка соединения с backend.</p>";
  }
});
</script>
